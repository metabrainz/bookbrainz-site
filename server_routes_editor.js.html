<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>server/routes/editor.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Achievement.html">Achievement</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Achievement.html#._awardAchievement">_awardAchievement</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Achievement.html#._awardUnlock">_awardUnlock</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Achievement.html#~_awardTitle">_awardTitle</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Achievement.html#~_processHotOffThePress">_processHotOffThePress</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Achievement.html#~_processMarathoner">_processMarathoner</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Achievement.html#~_processPageVisit">_processPageVisit</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Achievement.html#~_processSprinter">_processSprinter</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Achievement.html#~_testTiers">_testTiers</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Achievement.html#~awardUnlock">awardUnlock</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Achievement.html#~getEditionDateDifference">getEditionDateDifference</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Achievement.html#~testTiers">testTiers</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#_createAdminLog">_createAdminLog</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#_getAllEntities">_getAllEntities</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#_getAssociatedEntityRevisions">_getAssociatedEntityRevisions</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#_getAvailableWikipediaArticles">_getAvailableWikipediaArticles</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#_getIdByField">_getIdByField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#_getLast30DaysEntities">_getLast30DaysEntities</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#_getOrderedCollectionsForEditorPage">_getOrderedCollectionsForEditorPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#_getOrderedPublicCollections">_getOrderedPublicCollections</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#_getOrderedRevisions">_getOrderedRevisions</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#_loadWorkTableAuthors">_loadWorkTableAuthors</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#_parseLanguages">_parseLanguages</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#_relationshipTypeCreateOrEditHandler">_relationshipTypeCreateOrEditHandler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#_searchOption">_searchOption</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#_selectWikipediaPage">_selectWikipediaPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#AboutPage">AboutPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#AchievementComponent">AchievementComponent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addAliasRow">addAliasRow</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addAuthor">addAuthor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addAuthorCreditRow">addAuthorCreditRow</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addAuthorsDataToWorks">addAuthorsDataToWorks</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addBulkSeriesItems">addBulkSeriesItems</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addEditionGroup">addEditionGroup</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addIdentifierRow">addIdentifierRow</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addInitialRelationship">addInitialRelationship</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#additionalAuthorProps">additionalAuthorProps</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#additionalEditionProps">additionalEditionProps</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#additionalPublisherProps">additionalPublisherProps</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#additionalSeriesProps">additionalSeriesProps</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addLanguage">addLanguage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addOtherISBN">addOtherISBN</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addPublisher">addPublisher</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addSeries">addSeries</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addSeriesItem">addSeriesItem</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addWork">addWork</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#AdminPanelSearchResults">AdminPanelSearchResults</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#AliasButton">AliasButton</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#AliasEditor">AliasEditor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#AliasEditorMerge">AliasEditorMerge</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#AliasRow">AliasRow</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#AliasRowMerge">AliasRowMerge</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#AnnotationSection">AnnotationSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#areaToOption">areaToOption</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#assignIfNotSet">assignIfNotSet</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#attachAttribToRelForDisplay">attachAttribToRelForDisplay</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#attachAttributes">attachAttributes</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#AuthorCreditEditor">AuthorCreditEditor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#AuthorCreditRow">AuthorCreditRow</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#AuthorSection">AuthorSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#AuthorSectionMerge">AuthorSectionMerge</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#ButtonBar">ButtonBar</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#cacheMaxAge">cacheMaxAge</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#calIsbn10Chk">calIsbn10Chk</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#calIsbn13Chk">calIsbn13Chk</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#CallToAction">CallToAction</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#checkIfNameExists">checkIfNameExists</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#checkPrivilege">checkPrivilege</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#cleanupOnExit">cleanupOnExit</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#clearAuthor">clearAuthor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#clearAuthorCredit">clearAuthorCredit</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#clearEditionGroups">clearEditionGroups</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#clearPublisher">clearPublisher</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#clearPublishers">clearPublishers</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#closeEntityModal">closeEntityModal</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#collapseWhiteSpaces">collapseWhiteSpaces</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#collectionCreateOrEditHandler">collectionCreateOrEditHandler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#constructAdminLogStatement">constructAdminLogStatement</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#ContributePage">ContributePage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createEntitiesHandler">createEntitiesHandler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createEntityPageTitle">createEntityPageTitle</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#dateObjectToISOString">dateObjectToISOString</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdateAliasName">debouncedUpdateAliasName</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdateAliasSortName">debouncedUpdateAliasSortName</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdateBeginDate">debouncedUpdateBeginDate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdateDepth">debouncedUpdateDepth</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdateDisambiguationField">debouncedUpdateDisambiguationField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdateEndDate">debouncedUpdateEndDate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdateHeight">debouncedUpdateHeight</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdateIdentifierValue">debouncedUpdateIdentifierValue</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdateISBNValue">debouncedUpdateISBNValue</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdateNameField">debouncedUpdateNameField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdatePages">debouncedUpdatePages</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdateReleaseDate">debouncedUpdateReleaseDate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdateSortNameField">debouncedUpdateSortNameField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdateWeight">debouncedUpdateWeight</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdateWidth">debouncedUpdateWidth</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debounceUpdateAnnotation">debounceUpdateAnnotation</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debounceUpdateRevisionNote">debounceUpdateRevisionNote</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#DevelopPage">DevelopPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#disablePhysical">disablePhysical</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#DisambiguationField">DisambiguationField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#dispatch">dispatch</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#DragAndDrop">DragAndDrop</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#DragAndDropImage">DragAndDropImage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#dumpEdition">dumpEdition</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#duplicateWork">duplicateWork</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#EditionGroupSection">EditionGroupSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#EditionGroupSectionMerge">EditionGroupSectionMerge</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#EditionSection">EditionSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#EditionSectionMerge">EditionSectionMerge</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#EditorAchievementTab">EditorAchievementTab</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#editSeriesItem">editSeriesItem</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#enablePhysical">enablePhysical</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#ended">ended</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#EntityCountTable">EntityCountTable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#EntityEditor">EntityEditor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#entityEditorMarkup">entityEditorMarkup</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#EntityMerge">EntityMerge</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#entityMergeMarkup">entityMergeMarkup</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#EntityRevisions">EntityRevisions</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#entityToOption">entityToOption</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#ErrorPage">ErrorPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#FAQPage">FAQPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#filterOutRelationshipTypeById">filterOutRelationshipTypeById</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#firstIndexOfUnbalancedParanthesis">firstIndexOfUnbalancedParanthesis</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#formatYearForDisplay">formatYearForDisplay</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#generateEntityMergeProps">generateEntityMergeProps</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#generateEntityProps">generateEntityProps</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#generateUnifiedProps">generateUnifiedProps</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getAcceptedLanguageCodes">getAcceptedLanguageCodes</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getAdditionalRelations">getAdditionalRelations</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getAllEntities">getAllEntities</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getAssociatedEntityRevisions">getAssociatedEntityRevisions</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getAuthorEntityMergeSection">getAuthorEntityMergeSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getAvailableWikipediaArticles">getAvailableWikipediaArticles</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getDefaultAliasIndex">getDefaultAliasIndex</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getEditionEntityMergeSection">getEditionEntityMergeSection</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getEditionGroupEntityMergeSection">getEditionGroupEntityMergeSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEntityByBBID">getEntityByBBID</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEntityLink">getEntityLink</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEntityModelByType">getEntityModelByType</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEntityModels">getEntityModels</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEntitySectionByType">getEntitySectionByType</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEntityTable">getEntityTable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getIdByField">getIdByField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getIdByLabel">getIdByLabel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getInitAttribute">getInitAttribute</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getOrderedCollectionsForEditorPage">getOrderedCollectionsForEditorPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getPrivilegeBitsArray">getPrivilegeBitsArray</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getProgress">getProgress</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getPublisherEntityMergeSection">getPublisherEntityMergeSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getRelationshipSourceByTypeId">getRelationshipSourceByTypeId</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getRelationshipTargetBBIDByTypeId">getRelationshipTargetBBIDByTypeId</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getRelationshipTargetByTypeId">getRelationshipTargetByTypeId</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getSeriesEntityMergeSection">getSeriesEntityMergeSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getTodayDate">getTodayDate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getUfValidator">getUfValidator</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getWikipediaExtractForWikidata">getWikipediaExtractForWikidata</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getWorkEntityMergeSection">getWorkEntityMergeSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#HelpPage">HelpPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#hideAliasEditor">hideAliasEditor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#hideAuthorCreditEditor">hideAuthorCreditEditor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#hideIdentifierEditor">hideIdentifierEditor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#IdentifierButton">IdentifierButton</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#IdentifierEditor">IdentifierEditor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#IdentifierRow">IdentifierRow</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#incrementEditorEditCountById">incrementEditorEditCountById</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#indexAutoCreatedEditionGroup">indexAutoCreatedEditionGroup</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#init">init</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#injectDefaultAliasName">injectDefaultAliasName</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#isArea">isArea</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#isbn10To13">isbn10To13</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#isbn13To10">isbn13To10</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#isCoverTabEmpty">isCoverTabEmpty</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#isDetailTabEmpty">isDetailTabEmpty</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#isNullDate">isNullDate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#ISODateStringToObject">ISODateStringToObject</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#isValidBBID">isValidBBID</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#LanguageField">LanguageField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#LicensingPage">LicensingPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#loadEdition">loadEdition</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#LoadingSpinner">LoadingSpinner</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#makeEntityCreateOrEditHandler">makeEntityCreateOrEditHandler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#makePromiseFromObject">makePromiseFromObject</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#MergeField">MergeField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#NameField">NameField</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#NameSection">NameSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#NameSectionMerge">NameSectionMerge</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#NumericField">NumericField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#openEntityModal">openEntityModal</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#parseAcceptLanguage">parseAcceptLanguage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#parseLanguages">parseLanguages</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PrivacyPage">PrivacyPage</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#PrivilegeTypes">PrivilegeTypes</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PublisherSection">PublisherSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PublisherSectionMerge">PublisherSectionMerge</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#recursivelyGetMergedEntitiesBBIDs">recursivelyGetMergedEntitiesBBIDs</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#RegistrationAuth">RegistrationAuth</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#relationshipTypeCreateOrEditHandler">relationshipTypeCreateOrEditHandler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#removeAliasRow">removeAliasRow</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#removeAllSeriesItems">removeAllSeriesItems</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#removeAuthorCreditRow">removeAuthorCreditRow</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#removeEmptyAliases">removeEmptyAliases</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#removeEmptyCreditRows">removeEmptyCreditRows</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#removeEmptyIdentifiers">removeEmptyIdentifiers</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#removeIdentifierRow">removeIdentifierRow</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#removeSeries">removeSeries</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#removeSeriesItem">removeSeriesItem</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#removeWork">removeWork</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#renderRelationship">renderRelationship</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#resetAuthorCredit">resetAuthorCredit</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#router">router</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#sanitize">sanitize</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#searchName">searchName</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#SearchResults">SearchResults</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#sendEmail">sendEmail</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#SeriesListItem">SeriesListItem</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#SeriesSection">SeriesSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#SeriesSectionMerge">SeriesSectionMerge</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#setAttribute">setAttribute</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#setSubmitError">setSubmitError</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#setSubmitted">setSubmitted</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#setupSessions">setupSessions</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#showAliasEditor">showAliasEditor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#showAuthorCreditEditor">showAuthorCreditEditor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#showIdentifierEditor">showIdentifierEditor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#SortNameField">SortNameField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#sortRelationshipOrdinal">sortRelationshipOrdinal</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#sortSeriesItems">sortSeriesItems</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#StatisticsPage">StatisticsPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#StrategyMock">StrategyMock</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#stringToHTMLWithLinks">stringToHTMLWithLinks</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#stripDot">stripDot</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#SubmissionSection">SubmissionSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#submitSingleEntity">submitSingleEntity</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#template">template</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#toggleAuthorCredit">toggleAuthorCredit</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#toggleCheck">toggleCheck</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#toggleShowEditionGroup">toggleShowEditionGroup</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#TopEditorsTable">TopEditorsTable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#transformISODateForDisplay">transformISODateForDisplay</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#transformISODateForSelect">transformISODateForSelect</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#transformNewForm">transformNewForm</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#unflatten">unflatten</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#unifiedFormMarkup">unifiedFormMarkup</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#UPDATE_WARN_IF_EDITION_GROUP_EXISTS">UPDATE_WARN_IF_EDITION_GROUP_EXISTS</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateAliasLanguage">updateAliasLanguage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateAliasPrimary">updateAliasPrimary</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateArea">updateArea</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateAuthorCredit">updateAuthorCredit</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateAutoISBN">updateAutoISBN</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateBeginArea">updateBeginArea</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateCreditAuthorValue">updateCreditAuthorValue</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateCreditDisplayValue">updateCreditDisplayValue</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateCreditJoinPhraseValue">updateCreditJoinPhraseValue</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateEditionGroup">updateEditionGroup</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateEndArea">updateEndArea</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateEnded">updateEnded</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateFormat">updateFormat</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateGender">updateGender</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateIdentifierType">updateIdentifierType</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateISBNType">updateISBNType</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateLanguageField">updateLanguageField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateLanguages">updateLanguages</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateNameField">updateNameField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateOrderType">updateOrderType</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updatePublisher">updatePublisher</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateSeriesType">updateSeriesType</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateSortNameField">updateSortNameField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateType">updateType</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateWork">updateWork</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#validateCoverTab">validateCoverTab</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#validateDetailTab">validateDetailTab</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#validateISBN">validateISBN</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#validateUnifiedForm">validateUnifiedForm</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#ValidationLabel">ValidationLabel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#ValueField">ValueField</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#wikidataIdentifierTypeIds">wikidataIdentifierTypeIds</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#WorkSection">WorkSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#WorkSectionMerge">WorkSectionMerge</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">server/routes/editor.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";

require("core-js/modules/es.object.keys.js");
require("core-js/modules/es.symbol.js");
require("core-js/modules/es.array.filter.js");
require("core-js/modules/es.object.get-own-property-descriptor.js");
require("core-js/modules/web.dom-collections.for-each.js");
require("core-js/modules/es.object.get-own-property-descriptors.js");
require("core-js/modules/es.weak-map.js");
var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
var _typeof = require("@babel/runtime/helpers/typeof");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
exports.getEditorActivity = getEditorActivity;
var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));
require("core-js/modules/es.parse-int.js");
require("core-js/modules/es.array.iterator.js");
require("core-js/modules/es.object.to-string.js");
require("core-js/modules/es.promise.js");
require("core-js/modules/es.string.iterator.js");
require("core-js/modules/web.dom-collections.iterator.js");
require("core-js/modules/es.date.to-json.js");
require("core-js/modules/web.url.to-json.js");
require("core-js/modules/es.function.name.js");
require("core-js/modules/es.array.includes.js");
require("core-js/modules/es.string.includes.js");
require("core-js/modules/es.array.map.js");
require("core-js/modules/es.array.reduce.js");
require("core-js/modules/es.set.js");
var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));
var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));
var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));
var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));
var _keys2 = _interopRequireDefault(require("lodash/keys"));
var _countBy2 = _interopRequireDefault(require("lodash/countBy"));
var auth = _interopRequireWildcard(require("../helpers/auth"));
var commonUtils = _interopRequireWildcard(require("../../common/helpers/utils"));
var error = _interopRequireWildcard(require("../../common/helpers/error"));
var propHelpers = _interopRequireWildcard(require("../../client/helpers/props"));
var search = _interopRequireWildcard(require("../../common/helpers/search"));
var _privilegesUtils = require("../../common/helpers/privileges-utils");
var _adminLogs = require("../helpers/adminLogs");
var _dateFns = require("date-fns");
var _props2 = require("../helpers/props");
var _achievement = require("../helpers/achievement");
var _utils2 = require("../helpers/utils");
var _editorAchievements = _interopRequireDefault(require("../../client/components/pages/parts/editor-achievements"));
var _collections = _interopRequireDefault(require("../../client/components/pages/collections"));
var _editor = _interopRequireDefault(require("../../client/containers/editor"));
var _editorRevision = _interopRequireDefault(require("../../client/components/pages/editor-revision"));
var _layout = _interopRequireDefault(require("../../client/containers/layout"));
var _profile = _interopRequireDefault(require("../../client/components/forms/profile"));
var _editorProfile = _interopRequireDefault(require("../../client/components/pages/parts/editor-profile"));
var _react = _interopRequireDefault(require("react"));
var _server = _interopRequireDefault(require("react-dom/server"));
var _express = _interopRequireDefault(require("express"));
var _collections2 = require("../helpers/collections");
var _revisions = require("../helpers/revisions");
var _target = _interopRequireDefault(require("../templates/target"));
function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }
function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop &amp;&amp; obj &amp;&amp; obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" &amp;&amp; typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache &amp;&amp; cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty &amp;&amp; Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" &amp;&amp; Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc &amp;&amp; (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }
function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly &amp;&amp; (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }
function _objectSpread(target) { for (var i = 1; i &lt; arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; } /*
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * Copyright (C) 2015, 2020  Ben Ockmore
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          *               2015-2016   Sean Burke
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * This program is free software; you can redistribute it and/or modify
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * it under the terms of the GNU General Public License as published by
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * the Free Software Foundation; either version 2 of the License, or
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * (at your option) any later version.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * This program is distributed in the hope that it will be useful,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * but WITHOUT ANY WARRANTY; without even the implied warranty of
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * GNU General Public License for more details.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * You should have received a copy of the GNU General Public License along
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * with this program; if not, write to the Free Software Foundation, Inc.,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          */
var ADMIN = _privilegesUtils.PrivilegeType.ADMIN;
var router = _express.default.Router();
router.get('/edit', auth.isAuthenticated, /*#__PURE__*/function () {
  var _ref = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee(req, res, next) {
    var _req$app$locals$orm, Editor, Gender, TitleUnlock, editorModelPromise, titleUnlockModelPromise, gendersModelPromise, _yield$Promise$all$ca, _yield$Promise$all$ca2, editorModel, titleUnlockModel, genderModel, editorJSON, titleJSON, genderJSON, props, markup;
    return _regenerator.default.wrap(function _callee$(_context) {
      while (1) {
        switch (_context.prev = _context.next) {
          case 0:
            _req$app$locals$orm = req.app.locals.orm, Editor = _req$app$locals$orm.Editor, Gender = _req$app$locals$orm.Gender, TitleUnlock = _req$app$locals$orm.TitleUnlock; // Prepare three promises to be resolved in parallel to fetch the required
            // data.
            editorModelPromise = new Editor({
              id: parseInt(req.user.id, 10)
            }).fetch({
              require: true,
              withRelated: ['area', 'gender']
            }).catch(Editor.NotFoundError, function () {
              throw new error.NotFoundError('Editor not found', req);
            });
            titleUnlockModelPromise = new TitleUnlock().where('editor_id', parseInt(req.user.id, 10)).fetchAll({
              require: false,
              withRelated: ['title']
            });
            gendersModelPromise = new Gender().fetchAll({
              require: false
            }); // Parallel fetch the three required models. Only "editorModelPromise" has
            // "require: true", so only that can throw a NotFoundError, which is why the
            // other two model fetch operations have no error handling.
            _context.next = 6;
            return Promise.all([editorModelPromise, titleUnlockModelPromise, gendersModelPromise]).catch(next);
          case 6:
            _yield$Promise$all$ca = _context.sent;
            _yield$Promise$all$ca2 = (0, _slicedToArray2.default)(_yield$Promise$all$ca, 3);
            editorModel = _yield$Promise$all$ca2[0];
            titleUnlockModel = _yield$Promise$all$ca2[1];
            genderModel = _yield$Promise$all$ca2[2];
            // Convert the requested models to JSON structures.
            editorJSON = editorModel.toJSON();
            titleJSON = titleUnlockModel === null ? {} : titleUnlockModel.toJSON();
            genderJSON = genderModel ? genderModel.toJSON() : []; // Populate the props to be passed to React with the fetched and formatted
            // information.
            props = (0, _props2.generateProps)(req, res, {
              editor: editorJSON,
              genders: genderJSON,
              titles: titleJSON
            }); // Render the DOM
            markup = _server.default.renderToString( /*#__PURE__*/_react.default.createElement(_layout.default, propHelpers.extractLayoutProps(props), /*#__PURE__*/_react.default.createElement(_profile.default, {
              editor: props.editor,
              genders: props.genders,
              titles: props.titles
            }))); // Send the rendered DOM, the props and the script to the client
            res.send((0, _target.default)({
              markup: markup,
              props: (0, _props2.escapeProps)(props),
              script: '/js/editor/edit.js'
            }));
          case 17:
          case "end":
            return _context.stop();
        }
      }
    }, _callee);
  }));
  return function (_x, _x2, _x3) {
    return _ref.apply(this, arguments);
  };
}());
function isCurrentUser(reqUserID, sessionUser) {
  // No session user set, so cannot be true.
  if (!sessionUser) {
    return false;
  }

  // Return true if session user is set and matches the given ID.
  return reqUserID === sessionUser.id;
}
router.post('/edit/handler', auth.isAuthenticatedForHandler, /*#__PURE__*/function () {
  var _ref2 = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee2(req, res) {
    var Editor, editor, modifiedEditor, editorJSON;
    return _regenerator.default.wrap(function _callee2$(_context2) {
      while (1) {
        switch (_context2.prev = _context2.next) {
          case 0:
            _context2.prev = 0;
            Editor = req.app.locals.orm.Editor;
            if (isCurrentUser(req.body.id, req.user)) {
              _context2.next = 4;
              break;
            }
            throw new error.PermissionDeniedError('You do not have permission to edit that user', req);
          case 4:
            _context2.next = 6;
            return Editor.forge({
              id: parseInt(req.user.id, 10)
            }).fetch({
              require: true
            }).catch(Editor.NotFoundError, function () {
              throw new error.NotFoundError('Editor not found', req);
            });
          case 6:
            editor = _context2.sent;
            if (!(editor.get('areaId') === req.body.areaId &amp;&amp; editor.get('bio') === req.body.bio &amp;&amp; editor.get('name') === req.body.name &amp;&amp; editor.get('titleUnlockId') === req.body.title &amp;&amp; editor.get('genderId') === req.body.genderId)) {
              _context2.next = 9;
              break;
            }
            throw new error.FormSubmissionError('No change to the profile');
          case 9:
            _context2.next = 11;
            return editor.save({
              areaId: req.body.areaId,
              bio: req.body.bio,
              genderId: req.body.genderId,
              name: req.body.name,
              titleUnlockId: req.body.title
            }).catch(function (err) {
              if (err.constraint === 'editor_name_key') {
                throw new error.ConflictError('Name already in use');
              }
              throw new error.FormSubmissionError();
            });
          case 11:
            modifiedEditor = _context2.sent;
            res.locals.user.name = req.body.name;
            editorJSON = modifiedEditor.toJSON(); // Type needed for indexing
            modifiedEditor.set('type', 'Editor');
            _context2.next = 17;
            return search.indexEntity(modifiedEditor);
          case 17:
            return _context2.abrupt("return", res.status(200).send(editorJSON));
          case 20:
            _context2.prev = 20;
            _context2.t0 = _context2["catch"](0);
            return _context2.abrupt("return", error.sendErrorAsJSON(res, _context2.t0));
          case 23:
          case "end":
            return _context2.stop();
        }
      }
    }, _callee2, null, [[0, 20]]);
  }));
  return function (_x4, _x5) {
    return _ref2.apply(this, arguments);
  };
}());
router.post('/privs/edit/handler', auth.isAuthenticatedForHandler, auth.isAuthorized(ADMIN), /*#__PURE__*/function () {
  var _ref3 = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee3(req, res, next) {
    var _req$app$locals$orm2, Editor, AdminLog, bookshelf, _req$body, adminId, newPrivs, note, oldPrivs, targetUserId, actionType, trx, editor, logData;
    return _regenerator.default.wrap(function _callee3$(_context3) {
      while (1) {
        switch (_context3.prev = _context3.next) {
          case 0:
            _req$app$locals$orm2 = req.app.locals.orm, Editor = _req$app$locals$orm2.Editor, AdminLog = _req$app$locals$orm2.AdminLog, bookshelf = _req$app$locals$orm2.bookshelf;
            _req$body = req.body, adminId = _req$body.adminId, newPrivs = _req$body.newPrivs, note = _req$body.note, oldPrivs = _req$body.oldPrivs, targetUserId = _req$body.targetUserId;
            actionType = _privilegesUtils.AdminActionType.CHANGE_PRIV;
            _context3.prev = 3;
            _context3.next = 6;
            return bookshelf.transaction();
          case 6:
            trx = _context3.sent;
            _context3.next = 9;
            return Editor.forge({
              id: parseInt(targetUserId, 10)
            }).fetch({
              require: true,
              transacting: trx
            }).catch(Editor.NotFoundError, function () {
              return next(new error.NotFoundError('Editor not found', req));
            });
          case 9:
            editor = _context3.sent;
            if (!(editor.get('privs') === newPrivs)) {
              _context3.next = 12;
              break;
            }
            return _context3.abrupt("return", next(new error.FormSubmissionError('No change to Privileges', req)));
          case 12:
            if (note.length) {
              _context3.next = 14;
              break;
            }
            return _context3.abrupt("return", next(new error.FormSubmissionError('You must add a note to this action!', req)));
          case 14:
            _context3.next = 16;
            return editor.save({
              privs: newPrivs
            }, {
              transacting: trx
            });
          case 16:
            logData = {
              actionType: actionType,
              adminId: adminId,
              newPrivs: newPrivs,
              note: note,
              oldPrivs: oldPrivs,
              targetUserId: targetUserId
            };
            _context3.next = 19;
            return (0, _adminLogs.createAdminLog)(logData, AdminLog, trx);
          case 19:
            _context3.next = 21;
            return trx.commit();
          case 21:
            return _context3.abrupt("return", res.status(200).send());
          case 24:
            _context3.prev = 24;
            _context3.t0 = _context3["catch"](3);
            return _context3.abrupt("return", next(_context3.t0));
          case 27:
          case "end":
            return _context3.stop();
        }
      }
    }, _callee3, null, [[3, 24]]);
  }));
  return function (_x6, _x7, _x8) {
    return _ref3.apply(this, arguments);
  };
}());
function getEditorTitleJSON(_x9, _x10) {
  return _getEditorTitleJSON.apply(this, arguments);
}
function _getEditorTitleJSON() {
  _getEditorTitleJSON = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee11(editorJSON, TitleUnlock) {
    var unlockID, titleUnlockModel;
    return _regenerator.default.wrap(function _callee11$(_context11) {
      while (1) {
        switch (_context11.prev = _context11.next) {
          case 0:
            unlockID = editorJSON.titleUnlockId;
            if (!(unlockID === null)) {
              _context11.next = 3;
              break;
            }
            return _context11.abrupt("return", editorJSON);
          case 3:
            _context11.next = 5;
            return new TitleUnlock({
              id: unlockID
            }).fetch({
              require: false,
              withRelated: ['title']
            });
          case 5:
            titleUnlockModel = _context11.sent;
            if (titleUnlockModel !== null) {
              editorJSON.title = titleUnlockModel.relations.title.attributes;
            }
            return _context11.abrupt("return", editorJSON);
          case 8:
          case "end":
            return _context11.stop();
        }
      }
    }, _callee11);
  }));
  return _getEditorTitleJSON.apply(this, arguments);
}
function getIdEditorJSONPromise(_x11, _x12) {
  return _getIdEditorJSONPromise.apply(this, arguments);
}
function _getIdEditorJSONPromise() {
  _getIdEditorJSONPromise = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee12(userId, req) {
    var _req$app$locals$orm6, Editor, TitleUnlock, editorData;
    return _regenerator.default.wrap(function _callee12$(_context12) {
      while (1) {
        switch (_context12.prev = _context12.next) {
          case 0:
            _req$app$locals$orm6 = req.app.locals.orm, Editor = _req$app$locals$orm6.Editor, TitleUnlock = _req$app$locals$orm6.TitleUnlock;
            _context12.next = 3;
            return new Editor({
              id: userId
            }).fetch({
              require: true,
              withRelated: ['type', 'gender', 'area']
            }).catch(Editor.NotFoundError, function () {
              throw new error.NotFoundError('Editor not found', req);
            });
          case 3:
            editorData = _context12.sent;
            return _context12.abrupt("return", getEditorTitleJSON(editorData.toJSON(), TitleUnlock));
          case 5:
          case "end":
            return _context12.stop();
        }
      }
    }, _callee12);
  }));
  return _getIdEditorJSONPromise.apply(this, arguments);
}
function getEditorActivity(_x13, _x14, _x15) {
  return _getEditorActivity.apply(this, arguments);
}
function _getEditorActivity() {
  _getEditorActivity = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee13(editorId, startDate, Revision) {
    var endDate,
      revisions,
      revisionJSON,
      revisionDates,
      revisionsCount,
      firstRevisionDate,
      activityStart,
      allMonthsInInterval,
      _args13 = arguments;
    return _regenerator.default.wrap(function _callee13$(_context13) {
      while (1) {
        switch (_context13.prev = _context13.next) {
          case 0:
            endDate = _args13.length > 3 &amp;&amp; _args13[3] !== undefined ? _args13[3] : Date.now();
            if ((0, _dateFns.isValid)(startDate)) {
              _context13.next = 3;
              break;
            }
            throw new Error('Start date is invalid');
          case 3:
            if ((0, _dateFns.isValid)(endDate)) {
              _context13.next = 5;
              break;
            }
            throw new Error('End date is invalid');
          case 5:
            if ((0, _dateFns.isAfter)(endDate, startDate)) {
              _context13.next = 7;
              break;
            }
            throw new Error('Start date is greater than end date');
          case 7:
            _context13.next = 9;
            return new Revision().query('where', 'author_id', '=', editorId).orderBy('created_at', 'ASC').fetchAll({
              require: false
            });
          case 9:
            revisions = _context13.sent;
            revisionJSON = revisions ? revisions.toJSON() : [];
            revisionDates = revisionJSON.map(function (revision) {
              return (0, _dateFns.format)(new Date(revision.createdAt), 'LLL-yy');
            });
            revisionsCount = (0, _countBy2.default)(revisionDates);
            firstRevisionDate = revisionJSON.length ? revisionJSON[0].createdAt : Date.now();
            activityStart = startDate > firstRevisionDate ? firstRevisionDate : startDate;
            allMonthsInInterval = (0, _dateFns.eachMonthOfInterval)({
              end: endDate,
              start: activityStart
            }).map(function (month) {
              return (0, _dateFns.format)(new Date(month), 'LLL-yy');
            }).reduce(function (accumulator, month) {
              accumulator[month] = 0;
              return accumulator;
            }, {});
            return _context13.abrupt("return", _objectSpread(_objectSpread({}, allMonthsInInterval), revisionsCount));
          case 17:
          case "end":
            return _context13.stop();
        }
      }
    }, _callee13);
  }));
  return _getEditorActivity.apply(this, arguments);
}
function achievementColToEditorGetJSON(achievementCol) {
  if (!achievementCol) {
    return {
      length: 0,
      model: null
    };
  }
  return {
    length: achievementCol.length,
    model: achievementCol.toJSON()
  };
}
router.get('/:id', /*#__PURE__*/function () {
  var _ref4 = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee4(req, res, next) {
    var _req$app$locals$orm3, AchievementUnlock, Revision, userId, editorJSON, achievementCol, achievementJSON, props, markup;
    return _regenerator.default.wrap(function _callee4$(_context4) {
      while (1) {
        switch (_context4.prev = _context4.next) {
          case 0:
            _req$app$locals$orm3 = req.app.locals.orm, AchievementUnlock = _req$app$locals$orm3.AchievementUnlock, Revision = _req$app$locals$orm3.Revision;
            userId = parseInt(req.params.id, 10);
            if (userId) {
              _context4.next = 4;
              break;
            }
            return _context4.abrupt("return", next(new error.BadRequestError('Editor Id is not valid!', req)));
          case 4:
            _context4.prev = 4;
            _context4.next = 7;
            return getIdEditorJSONPromise(userId, req);
          case 7:
            editorJSON = _context4.sent;
            _context4.next = 10;
            return new AchievementUnlock().where('editor_id', userId).where('profile_rank', '&lt;=', '3').query(function (qb) {
              return qb.limit(3);
            }).orderBy('profile_rank', 'ASC').fetchAll({
              require: false,
              withRelated: ['achievement']
            });
          case 10:
            achievementCol = _context4.sent;
            _context4.next = 13;
            return getEditorActivity(editorJSON.id, editorJSON.createdAt, Revision);
          case 13:
            editorJSON.activityData = _context4.sent;
            achievementJSON = achievementColToEditorGetJSON(achievementCol);
            props = (0, _props2.generateProps)(req, res, {
              achievement: achievementJSON,
              editor: editorJSON,
              tabActive: 0
            });
            markup = _server.default.renderToString( /*#__PURE__*/_react.default.createElement(_layout.default, propHelpers.extractLayoutProps(props), /*#__PURE__*/_react.default.createElement(_editor.default, propHelpers.extractEditorProps(props), /*#__PURE__*/_react.default.createElement(_editorProfile.default, (0, _extends2.default)({
              user: props.user
            }, propHelpers.extractChildProps(props))))));
            return _context4.abrupt("return", res.send((0, _target.default)({
              markup: markup,
              page: 'profile',
              props: (0, _props2.escapeProps)(props),
              script: '/js/editor/editor.js',
              title: "".concat(props.editor.name, "'s Profile")
            })));
          case 20:
            _context4.prev = 20;
            _context4.t0 = _context4["catch"](4);
            return _context4.abrupt("return", next(_context4.t0));
          case 23:
          case "end":
            return _context4.stop();
        }
      }
    }, _callee4, null, [[4, 20]]);
  }));
  return function (_x16, _x17, _x18) {
    return _ref4.apply(this, arguments);
  };
}());

// eslint-disable-next-line consistent-return
router.get('/:id/revisions', /*#__PURE__*/function () {
  var _ref5 = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee5(req, res, next) {
    var DEFAULT_MAX_REVISIONS, DEFAULT_REVISION_OFFSET, query, size, from, orderedRevisionsPromise, editorJSONPromise, _yield$Promise$all, _yield$Promise$all2, orderedRevisions, editorJSON, _commonUtils$getNextE, newResultsArray, nextEnabled, props, markup;
    return _regenerator.default.wrap(function _callee5$(_context5) {
      while (1) {
        switch (_context5.prev = _context5.next) {
          case 0:
            DEFAULT_MAX_REVISIONS = 20;
            DEFAULT_REVISION_OFFSET = 0;
            query = (0, _utils2.parseQuery)(req.url);
            size = (0, _utils2.getIntFromQueryParams)(query, 'size', DEFAULT_MAX_REVISIONS);
            from = (0, _utils2.getIntFromQueryParams)(query, 'from', DEFAULT_REVISION_OFFSET);
            _context5.prev = 5;
            // get 1 more result to check nextEnabled
            orderedRevisionsPromise = (0, _revisions.getOrderedRevisionForEditorPage)(from, size + 1, req);
            editorJSONPromise = getIdEditorJSONPromise(req.params.id, req);
            _context5.next = 10;
            return Promise.all([orderedRevisionsPromise, editorJSONPromise]);
          case 10:
            _yield$Promise$all = _context5.sent;
            _yield$Promise$all2 = (0, _slicedToArray2.default)(_yield$Promise$all, 2);
            orderedRevisions = _yield$Promise$all2[0];
            editorJSON = _yield$Promise$all2[1];
            _commonUtils$getNextE = commonUtils.getNextEnabledAndResultsArray(orderedRevisions, size), newResultsArray = _commonUtils$getNextE.newResultsArray, nextEnabled = _commonUtils$getNextE.nextEnabled;
            props = (0, _props2.generateProps)(req, res, {
              editor: editorJSON,
              from: from,
              nextEnabled: nextEnabled,
              results: newResultsArray,
              showRevisionNote: true,
              size: size,
              tabActive: 1,
              tableHeading: 'Revision History'
            });
            markup = _server.default.renderToString( /*#__PURE__*/_react.default.createElement(_layout.default, propHelpers.extractLayoutProps(props), /*#__PURE__*/_react.default.createElement(_editor.default, propHelpers.extractEditorProps(props), /*#__PURE__*/_react.default.createElement(_editorRevision.default, propHelpers.extractChildProps(props)))));
            res.send((0, _target.default)({
              markup: markup,
              page: 'revisions',
              props: (0, _props2.escapeProps)(props),
              script: '/js/editor/editor.js',
              title: "".concat(props.editor.name, "'s Revisions")
            }));
            _context5.next = 23;
            break;
          case 20:
            _context5.prev = 20;
            _context5.t0 = _context5["catch"](5);
            return _context5.abrupt("return", next(_context5.t0));
          case 23:
          case "end":
            return _context5.stop();
        }
      }
    }, _callee5, null, [[5, 20]]);
  }));
  return function (_x19, _x20, _x21) {
    return _ref5.apply(this, arguments);
  };
}());
router.get('/:id/revisions/revisions', /*#__PURE__*/function () {
  var _ref6 = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee6(req, res, next) {
    var DEFAULT_MAX_REVISIONS, DEFAULT_REVISION_OFFSET, query, size, from, orderedRevisions;
    return _regenerator.default.wrap(function _callee6$(_context6) {
      while (1) {
        switch (_context6.prev = _context6.next) {
          case 0:
            DEFAULT_MAX_REVISIONS = 20;
            DEFAULT_REVISION_OFFSET = 0;
            query = (0, _utils2.parseQuery)(req.url);
            size = (0, _utils2.getIntFromQueryParams)(query, 'size', DEFAULT_MAX_REVISIONS);
            from = (0, _utils2.getIntFromQueryParams)(query, 'from', DEFAULT_REVISION_OFFSET);
            _context6.next = 7;
            return (0, _revisions.getOrderedRevisionForEditorPage)(from, size, req).catch(next);
          case 7:
            orderedRevisions = _context6.sent;
            res.send(orderedRevisions);
          case 9:
          case "end":
            return _context6.stop();
        }
      }
    }, _callee6);
  }));
  return function (_x22, _x23, _x24) {
    return _ref6.apply(this, arguments);
  };
}());

/**
 * Get progress counter of achievement for a editor
 * @param {number} achievementId - Achivement Type id
 * @param {number} editorId - editorId
 * @param {object} orm - orm
 * @returns {Promise&lt;number>} - Promise resolved to progress counter
 */
function getProgress(_x25, _x26, _x27) {
  return _getProgress.apply(this, arguments);
}
function _getProgress() {
  _getProgress = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee14(achievementId, editorId, orm) {
    var revisionist, Editor, editor, revisions, authorRevisionist, editionGroupRevisionist, publisherRevisionist, editionRevisionist, workRevisionist, seriesRevisionist, AuthorRevision, EditionGroupRevision, EditionRevision, PublisherRevision, WorkRevision, SeriesRevision, bookshelf, rawSql, out, explorerVisits;
    return _regenerator.default.wrap(function _callee14$(_context14) {
      while (1) {
        switch (_context14.prev = _context14.next) {
          case 0:
            revisionist = [1, 2, 3];
            if (!revisionist.includes(achievementId)) {
              _context14.next = 8;
              break;
            }
            Editor = orm.Editor;
            _context14.next = 5;
            return new Editor({
              id: editorId
            }).fetch({
              require: false
            });
          case 5:
            editor = _context14.sent;
            revisions = editor.get('revisionsApplied');
            return _context14.abrupt("return", revisions);
          case 8:
            // entity revisionist
            authorRevisionist = [4, 5, 6];
            editionGroupRevisionist = [7, 8, 9];
            publisherRevisionist = [15, 16, 17];
            editionRevisionist = [18, 19, 20];
            workRevisionist = [21, 22, 23];
            seriesRevisionist = [28, 29, 30];
            if (!authorRevisionist.includes(achievementId)) {
              _context14.next = 17;
              break;
            }
            AuthorRevision = orm.AuthorRevision;
            return _context14.abrupt("return", (0, _achievement.getTypeCreation)(new AuthorRevision(), 'author_revision', editorId));
          case 17:
            if (!editionGroupRevisionist.includes(achievementId)) {
              _context14.next = 20;
              break;
            }
            EditionGroupRevision = orm.EditionGroupRevision;
            return _context14.abrupt("return", (0, _achievement.getTypeCreation)(new EditionGroupRevision(), 'edition_group_revision', editorId));
          case 20:
            if (!editionRevisionist.includes(achievementId)) {
              _context14.next = 23;
              break;
            }
            EditionRevision = orm.EditionRevision;
            return _context14.abrupt("return", (0, _achievement.getTypeCreation)(new EditionRevision(), 'edition_revision', editorId));
          case 23:
            if (!publisherRevisionist.includes(achievementId)) {
              _context14.next = 26;
              break;
            }
            PublisherRevision = orm.PublisherRevision;
            return _context14.abrupt("return", (0, _achievement.getTypeCreation)(new PublisherRevision(), 'publisher_revision', editorId));
          case 26:
            if (!workRevisionist.includes(achievementId)) {
              _context14.next = 29;
              break;
            }
            WorkRevision = orm.WorkRevision;
            return _context14.abrupt("return", (0, _achievement.getTypeCreation)(new WorkRevision(), 'work_revision', editorId));
          case 29:
            if (!seriesRevisionist.includes(achievementId)) {
              _context14.next = 32;
              break;
            }
            SeriesRevision = orm.SeriesRevision;
            return _context14.abrupt("return", (0, _achievement.getTypeCreation)(new SeriesRevision(), 'series_revision', editorId));
          case 32:
            if (!(achievementId === 10)) {
              _context14.next = 39;
              break;
            }
            bookshelf = orm.bookshelf;
            rawSql = "SELECT * from bookbrainz.revision WHERE author_id=".concat(editorId, " \t\tand created_at > (SELECT CURRENT_DATE - INTERVAL '1 hour');");
            _context14.next = 37;
            return bookshelf.knex.raw(rawSql);
          case 37:
            out = _context14.sent;
            return _context14.abrupt("return", out.rowCount);
          case 39:
            if (!(achievementId === 11)) {
              _context14.next = 41;
              break;
            }
            return _context14.abrupt("return", (0, _achievement.getConsecutiveDaysWithEdits)(orm, editorId, 6));
          case 41:
            if (!(achievementId === 12)) {
              _context14.next = 43;
              break;
            }
            return _context14.abrupt("return", (0, _achievement.getConsecutiveDaysWithEdits)(orm, editorId, 29));
          case 43:
            // Explorer achivements
            explorerVisits = [24, 25, 26];
            if (!explorerVisits.includes(achievementId)) {
              _context14.next = 46;
              break;
            }
            return _context14.abrupt("return", (0, _achievement.getEntityVisits)(orm, editorId));
          case 46:
            return _context14.abrupt("return", 0);
          case 47:
          case "end":
            return _context14.stop();
        }
      }
    }, _callee14);
  }));
  return _getProgress.apply(this, arguments);
}
function setAchievementUnlockedField(_x28, _x29, _x30, _x31) {
  return _setAchievementUnlockedField.apply(this, arguments);
}
function _setAchievementUnlockedField() {
  _setAchievementUnlockedField = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee16(achievements, unlocks, userId, orm) {
    var unlockIDSet, model;
    return _regenerator.default.wrap(function _callee16$(_context16) {
      while (1) {
        switch (_context16.prev = _context16.next) {
          case 0:
            if (unlocks) {
              _context16.next = 2;
              break;
            }
            return _context16.abrupt("return", null);
          case 2:
            unlockIDSet = new Set(unlocks.map('attributes.achievementId'));
            _context16.next = 5;
            return Promise.all(achievements.map( /*#__PURE__*/function () {
              var _ref11 = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee15(achievementType) {
                return _regenerator.default.wrap(function _callee15$(_context15) {
                  while (1) {
                    switch (_context15.prev = _context15.next) {
                      case 0:
                        _context15.t0 = _objectSpread;
                        _context15.t1 = _objectSpread({}, achievementType.toJSON());
                        _context15.t2 = {};
                        _context15.next = 5;
                        return getProgress(achievementType.id, userId, orm);
                      case 5:
                        _context15.t3 = _context15.sent;
                        _context15.t4 = unlockIDSet.has(achievementType.id);
                        _context15.t5 = {
                          counter: _context15.t3,
                          unlocked: _context15.t4
                        };
                        return _context15.abrupt("return", (0, _context15.t0)(_context15.t1, _context15.t2, _context15.t5));
                      case 9:
                      case "end":
                        return _context15.stop();
                    }
                  }
                }, _callee15);
              }));
              return function (_x47) {
                return _ref11.apply(this, arguments);
              };
            }()));
          case 5:
            model = _context16.sent;
            return _context16.abrupt("return", {
              model: model
            });
          case 7:
          case "end":
            return _context16.stop();
        }
      }
    }, _callee16);
  }));
  return _setAchievementUnlockedField.apply(this, arguments);
}
router.get('/:id/achievements', /*#__PURE__*/function () {
  var _ref7 = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee7(req, res, next) {
    var _req$app$locals$orm4, AchievementType, AchievementUnlock, userId, isOwner, editorJSONPromise, unlocksPromise, achievementColPromise, achievementTypesPromise, _yield$Promise$all3, _yield$Promise$all4, unlocks, editorJSON, achievementTypes, achievementCol, achievementJSON, currAchievementJSON, props, markup;
    return _regenerator.default.wrap(function _callee7$(_context7) {
      while (1) {
        switch (_context7.prev = _context7.next) {
          case 0:
            _req$app$locals$orm4 = req.app.locals.orm, AchievementType = _req$app$locals$orm4.AchievementType, AchievementUnlock = _req$app$locals$orm4.AchievementUnlock;
            userId = parseInt(req.params.id, 10);
            isOwner = isCurrentUser(userId, req.user);
            editorJSONPromise = getIdEditorJSONPromise(userId, req).catch(next);
            unlocksPromise = new AchievementUnlock().where('editor_id', userId).fetchAll({
              require: false
            });
            achievementColPromise = new AchievementUnlock().where('editor_id', userId).where('profile_rank', '&lt;=', '3').query(function (qb) {
              return qb.limit(3);
            }).orderBy('profile_rank', 'ASC').fetchAll({
              require: false,
              withRelated: ['achievement']
            });
            achievementTypesPromise = new AchievementType().orderBy('id', 'ASC').fetchAll();
            _context7.next = 9;
            return Promise.all([unlocksPromise, editorJSONPromise, achievementTypesPromise, achievementColPromise]);
          case 9:
            _yield$Promise$all3 = _context7.sent;
            _yield$Promise$all4 = (0, _slicedToArray2.default)(_yield$Promise$all3, 4);
            unlocks = _yield$Promise$all4[0];
            editorJSON = _yield$Promise$all4[1];
            achievementTypes = _yield$Promise$all4[2];
            achievementCol = _yield$Promise$all4[3];
            _context7.next = 17;
            return setAchievementUnlockedField(achievementTypes, unlocks, userId, res.app.locals.orm);
          case 17:
            achievementJSON = _context7.sent;
            currAchievementJSON = achievementColToEditorGetJSON(achievementCol);
            props = (0, _props2.generateProps)(req, res, {
              achievement: achievementJSON,
              currAchievement: currAchievementJSON,
              editor: editorJSON,
              isOwner: isOwner,
              tabActive: 2
            });
            markup = _server.default.renderToString( /*#__PURE__*/_react.default.createElement(_layout.default, propHelpers.extractLayoutProps(props), /*#__PURE__*/_react.default.createElement(_editor.default, propHelpers.extractEditorProps(props), /*#__PURE__*/_react.default.createElement(_editorAchievements.default, {
              achievement: props.achievement,
              currAchievement: props.currAchievement,
              editor: props.editor,
              isOwner: props.isOwner
            }))));
            res.send((0, _target.default)({
              markup: markup,
              props: (0, _props2.escapeProps)(props),
              script: '/js/editor/achievement.js',
              title: "".concat(props.editor.name, "'s Achievements")
            }));
          case 22:
          case "end":
            return _context7.stop();
        }
      }
    }, _callee7);
  }));
  return function (_x32, _x33, _x34) {
    return _ref7.apply(this, arguments);
  };
}());
function rankUpdate(_x35, _x36, _x37, _x38) {
  return _rankUpdate.apply(this, arguments);
}
function _rankUpdate() {
  _rankUpdate = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee17(orm, editorId, bodyRank, rank) {
    var AchievementUnlock, unlockToUnrank, unlockToRank;
    return _regenerator.default.wrap(function _callee17$(_context17) {
      while (1) {
        switch (_context17.prev = _context17.next) {
          case 0:
            AchievementUnlock = orm.AchievementUnlock; // Get the achievement unlock which is currently in this "rank"/slot
            _context17.next = 3;
            return new AchievementUnlock({
              editorId: editorId,
              profileRank: rank
            }).fetch({
              require: false
            });
          case 3:
            unlockToUnrank = _context17.sent;
            if (!(unlockToUnrank !== null)) {
              _context17.next = 7;
              break;
            }
            _context17.next = 7;
            return unlockToUnrank.set('profileRank', null).save();
          case 7:
            if (!(bodyRank === '')) {
              _context17.next = 9;
              break;
            }
            return _context17.abrupt("return", false);
          case 9:
            _context17.next = 11;
            return new AchievementUnlock({
              achievementId: parseInt(bodyRank, 10),
              editorId: editorId
            }).fetch({
              require: true
            });
          case 11:
            unlockToRank = _context17.sent;
            return _context17.abrupt("return", unlockToRank.set('profileRank', rank).save());
          case 13:
          case "end":
            return _context17.stop();
        }
      }
    }, _callee17);
  }));
  return _rankUpdate.apply(this, arguments);
}
router.post('/:id/achievements/', auth.isAuthenticated, /*#__PURE__*/function () {
  var _ref8 = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee8(req, res) {
    var orm, userId;
    return _regenerator.default.wrap(function _callee8$(_context8) {
      while (1) {
        switch (_context8.prev = _context8.next) {
          case 0:
            orm = req.app.locals.orm;
            userId = parseInt(req.params.id, 10);
            if (isCurrentUser(userId, req.user)) {
              _context8.next = 4;
              break;
            }
            throw new Error('Not authenticated');
          case 4:
            _context8.next = 6;
            return rankUpdate(orm, userId, req.body.rank1, 1);
          case 6:
            _context8.next = 8;
            return rankUpdate(orm, userId, req.body.rank2, 2);
          case 8:
            _context8.next = 10;
            return rankUpdate(orm, userId, req.body.rank3, 3);
          case 10:
            return _context8.abrupt("return", res.redirect("/editor/".concat(req.params.id)));
          case 11:
          case "end":
            return _context8.stop();
        }
      }
    }, _callee8);
  }));
  return function (_x39, _x40) {
    return _ref8.apply(this, arguments);
  };
}());

// eslint-disable-next-line consistent-return
router.get('/:id/collections', /*#__PURE__*/function () {
  var _ref9 = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee9(req, res, next) {
    var _req$app$locals$orm5, Editor, TitleUnlock, DEFAULT_MAX_COLLECTIONS, DEFAULT_COLLECTION_OFFSET, query, size, from, type, entityTypes, orderedCollections, _commonUtils$getNextE2, newResultsArray, nextEnabled, editor, editorJSON, props, markup;
    return _regenerator.default.wrap(function _callee9$(_context9) {
      while (1) {
        switch (_context9.prev = _context9.next) {
          case 0:
            _req$app$locals$orm5 = req.app.locals.orm, Editor = _req$app$locals$orm5.Editor, TitleUnlock = _req$app$locals$orm5.TitleUnlock;
            DEFAULT_MAX_COLLECTIONS = 20;
            DEFAULT_COLLECTION_OFFSET = 0;
            query = (0, _utils2.parseQuery)(req.url);
            size = (0, _utils2.getIntFromQueryParams)(query, 'size', DEFAULT_MAX_COLLECTIONS);
            from = (0, _utils2.getIntFromQueryParams)(query, 'from', DEFAULT_COLLECTION_OFFSET);
            type = query.get('type');
            _context9.prev = 7;
            entityTypes = (0, _keys2.default)(commonUtils.getEntityModels(req.app.locals.orm));
            if (!(!entityTypes.includes(type) &amp;&amp; type !== null)) {
              _context9.next = 11;
              break;
            }
            throw new error.BadRequestError("Type ".concat(type, " do not exist"));
          case 11:
            _context9.next = 13;
            return (0, _collections2.getOrderedCollectionsForEditorPage)(from, size + 1, type, req);
          case 13:
            orderedCollections = _context9.sent;
            _commonUtils$getNextE2 = commonUtils.getNextEnabledAndResultsArray(orderedCollections, size), newResultsArray = _commonUtils$getNextE2.newResultsArray, nextEnabled = _commonUtils$getNextE2.nextEnabled;
            _context9.next = 17;
            return new Editor({
              id: req.params.id
            }).fetch();
          case 17:
            editor = _context9.sent;
            _context9.next = 20;
            return getEditorTitleJSON(editor.toJSON(), TitleUnlock);
          case 20:
            editorJSON = _context9.sent;
            props = (0, _props2.generateProps)(req, res, {
              editor: editorJSON,
              entityTypes: entityTypes,
              from: from,
              nextEnabled: nextEnabled,
              results: newResultsArray,
              showIfOwnerOrCollaborator: true,
              showPrivacy: true,
              size: size,
              tabActive: 3,
              tableHeading: 'Collections'
            });
            markup = _server.default.renderToString( /*#__PURE__*/_react.default.createElement(_layout.default, propHelpers.extractLayoutProps(props), /*#__PURE__*/_react.default.createElement(_editor.default, propHelpers.extractEditorProps(props), /*#__PURE__*/_react.default.createElement(_collections.default, propHelpers.extractChildProps(props)))));
            res.send((0, _target.default)({
              markup: markup,
              page: 'collections',
              props: (0, _props2.escapeProps)(props),
              script: '/js/editor/editor.js',
              title: "".concat(props.editor.name, "'s Collections")
            }));
            _context9.next = 29;
            break;
          case 26:
            _context9.prev = 26;
            _context9.t0 = _context9["catch"](7);
            return _context9.abrupt("return", next(_context9.t0));
          case 29:
          case "end":
            return _context9.stop();
        }
      }
    }, _callee9, null, [[7, 26]]);
  }));
  return function (_x41, _x42, _x43) {
    return _ref9.apply(this, arguments);
  };
}());

// eslint-disable-next-line consistent-return
router.get('/:id/collections/collections', /*#__PURE__*/function () {
  var _ref10 = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee10(req, res, next) {
    var query, size, from, type, entityTypes, orderedCollections;
    return _regenerator.default.wrap(function _callee10$(_context10) {
      while (1) {
        switch (_context10.prev = _context10.next) {
          case 0:
            _context10.prev = 0;
            query = (0, _utils2.parseQuery)(req.url);
            size = (0, _utils2.getIntFromQueryParams)(query, 'size', 20);
            from = (0, _utils2.getIntFromQueryParams)(query, 'from');
            type = query.get('type');
            entityTypes = (0, _keys2.default)(commonUtils.getEntityModels(req.app.locals.orm));
            if (!(!entityTypes.includes(type) &amp;&amp; type !== null)) {
              _context10.next = 8;
              break;
            }
            throw new error.BadRequestError("Type ".concat(type, " do not exist"));
          case 8:
            _context10.next = 10;
            return (0, _collections2.getOrderedCollectionsForEditorPage)(from, size, type, req);
          case 10:
            orderedCollections = _context10.sent;
            res.send(orderedCollections);
            _context10.next = 17;
            break;
          case 14:
            _context10.prev = 14;
            _context10.t0 = _context10["catch"](0);
            return _context10.abrupt("return", next(_context10.t0));
          case 17:
          case "end":
            return _context10.stop();
        }
      }
    }, _callee10, null, [[0, 14]]);
  }));
  return function (_x44, _x45, _x46) {
    return _ref10.apply(this, arguments);
  };
}());
var _default = router;
exports.default = _default;
//# sourceMappingURL=editor.js.map</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Tue Jun 18 2024 18:36:20 GMT+0000 (Coordinated Universal Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
