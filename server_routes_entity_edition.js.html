<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>server/routes/entity/edition.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Achievement.html">Achievement</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Achievement.html#._awardAchievement">_awardAchievement</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Achievement.html#._awardUnlock">_awardUnlock</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Achievement.html#~_awardTitle">_awardTitle</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Achievement.html#~_processHotOffThePress">_processHotOffThePress</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Achievement.html#~_processMarathoner">_processMarathoner</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Achievement.html#~_processPageVisit">_processPageVisit</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Achievement.html#~_processSprinter">_processSprinter</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Achievement.html#~_testTiers">_testTiers</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Achievement.html#~awardUnlock">awardUnlock</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Achievement.html#~getEditionDateDifference">getEditionDateDifference</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Achievement.html#~testTiers">testTiers</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#_getAssociatedEntityRevisions">_getAssociatedEntityRevisions</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#_getIdByField">_getIdByField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#_getOrderedCollectionsForEditorPage">_getOrderedCollectionsForEditorPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#_getOrderedPublicCollections">_getOrderedPublicCollections</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#_getOrderedRevisions">_getOrderedRevisions</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#_parseLanguages">_parseLanguages</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#_searchOption">_searchOption</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#AboutPage">AboutPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addAliasRow">addAliasRow</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addAuthorsDataToWorks">addAuthorsDataToWorks</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addIdentifierRow">addIdentifierRow</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addInitialRelationship">addInitialRelationship</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#additionalAuthorProps">additionalAuthorProps</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#additionalEditionProps">additionalEditionProps</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#additionalPublisherProps">additionalPublisherProps</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#additionalSeriesProps">additionalSeriesProps</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addSeriesItem">addSeriesItem</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#AliasButton">AliasButton</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#AliasEditor">AliasEditor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#AliasEditorMerge">AliasEditorMerge</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#AliasRow">AliasRow</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#AliasRowMerge">AliasRowMerge</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#AnnotationSection">AnnotationSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#areaToOption">areaToOption</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#assignIfNotSet">assignIfNotSet</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#attachAttribToRelForDisplay">attachAttribToRelForDisplay</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#attachAttributes">attachAttributes</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#AuthorSection">AuthorSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#AuthorSectionMerge">AuthorSectionMerge</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#ButtonBar">ButtonBar</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#calIsbn10Chk">calIsbn10Chk</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#calIsbn13Chk">calIsbn13Chk</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#CallToAction">CallToAction</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#checkIfNameExists">checkIfNameExists</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#cleanupOnExit">cleanupOnExit</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#collapseWhiteSpaces">collapseWhiteSpaces</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#collectionCreateOrEditHandler">collectionCreateOrEditHandler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#ContributePage">ContributePage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createEntityPageTitle">createEntityPageTitle</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#dateObjectToISOString">dateObjectToISOString</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdateAliasName">debouncedUpdateAliasName</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdateAliasSortName">debouncedUpdateAliasSortName</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdateBeginDate">debouncedUpdateBeginDate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdateDepth">debouncedUpdateDepth</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdateDisambiguationField">debouncedUpdateDisambiguationField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdateEndDate">debouncedUpdateEndDate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdateHeight">debouncedUpdateHeight</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdateIdentifierValue">debouncedUpdateIdentifierValue</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdateNameField">debouncedUpdateNameField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdatePages">debouncedUpdatePages</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdateReleaseDate">debouncedUpdateReleaseDate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdateSortNameField">debouncedUpdateSortNameField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdateWeight">debouncedUpdateWeight</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debouncedUpdateWidth">debouncedUpdateWidth</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debounceUpdateAnnotation">debounceUpdateAnnotation</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#debounceUpdateRevisionNote">debounceUpdateRevisionNote</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#DevelopPage">DevelopPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#disablePhysical">disablePhysical</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#DisambiguationField">DisambiguationField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#dispatch">dispatch</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#DragAndDropImage">DragAndDropImage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#EditionGroupSection">EditionGroupSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#EditionGroupSectionMerge">EditionGroupSectionMerge</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#EditionSection">EditionSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#EditionSectionMerge">EditionSectionMerge</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#EditorAchievementTab">EditorAchievementTab</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#editSeriesItem">editSeriesItem</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#enablePhysical">enablePhysical</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#ended">ended</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#EntityCountTable">EntityCountTable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#EntityEditor">EntityEditor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#entityEditorMarkup">entityEditorMarkup</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#EntityMerge">EntityMerge</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#entityMergeMarkup">entityMergeMarkup</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#EntityRevisions">EntityRevisions</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#entityToOption">entityToOption</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#ErrorPage">ErrorPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#filterOutRelationshipTypeById">filterOutRelationshipTypeById</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#generateEntityMergeProps">generateEntityMergeProps</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#generateEntityProps">generateEntityProps</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getAdditionalRelations">getAdditionalRelations</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getAssociatedEntityRevisions">getAssociatedEntityRevisions</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getAuthorEntityMergeSection">getAuthorEntityMergeSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getDefaultAliasIndex">getDefaultAliasIndex</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getEditionEntityMergeSection">getEditionEntityMergeSection</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getEditionGroupEntityMergeSection">getEditionGroupEntityMergeSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEntityLink">getEntityLink</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEntityModelByType">getEntityModelByType</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEntityModels">getEntityModels</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEntitySectionByType">getEntitySectionByType</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEntityTable">getEntityTable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getIdByField">getIdByField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getIdByLabel">getIdByLabel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getInitAttribute">getInitAttribute</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getOrderedCollectionsForEditorPage">getOrderedCollectionsForEditorPage</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getPublisherEntityMergeSection">getPublisherEntityMergeSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getRelationshipSourceByTypeId">getRelationshipSourceByTypeId</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getRelationshipTargetBBIDByTypeId">getRelationshipTargetBBIDByTypeId</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getRelationshipTargetByTypeId">getRelationshipTargetByTypeId</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getSeriesEntityMergeSection">getSeriesEntityMergeSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getTodayDate">getTodayDate</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#getWorkEntityMergeSection">getWorkEntityMergeSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#HelpPage">HelpPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#hideAliasEditor">hideAliasEditor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#hideIdentifierEditor">hideIdentifierEditor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#IdentifierButton">IdentifierButton</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#IdentifierEditor">IdentifierEditor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#IdentifierRow">IdentifierRow</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#incrementEditorEditCountById">incrementEditorEditCountById</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#indexAutoCreatedEditionGroup">indexAutoCreatedEditionGroup</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#injectDefaultAliasName">injectDefaultAliasName</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#isArea">isArea</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#isbn10To13">isbn10To13</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#isbn13To10">isbn13To10</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#isNullDate">isNullDate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#ISODateStringToObject">ISODateStringToObject</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#isValidBBID">isValidBBID</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#LanguageField">LanguageField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#makeEntityCreateOrEditHandler">makeEntityCreateOrEditHandler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#makePromiseFromObject">makePromiseFromObject</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#MergeField">MergeField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#NameField">NameField</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#NameSection">NameSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#NameSectionMerge">NameSectionMerge</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#NumericField">NumericField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#parseLanguages">parseLanguages</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PrivacyPage">PrivacyPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PublisherSection">PublisherSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#PublisherSectionMerge">PublisherSectionMerge</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#recursivelyGetMergedEntitiesBBIDs">recursivelyGetMergedEntitiesBBIDs</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#RegistrationAuth">RegistrationAuth</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#removeAliasRow">removeAliasRow</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#removeEmptyAliases">removeEmptyAliases</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#removeEmptyIdentifiers">removeEmptyIdentifiers</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#removeIdentifierRow">removeIdentifierRow</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#removeSeriesItem">removeSeriesItem</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#renderRelationship">renderRelationship</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#router">router</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#sanitize">sanitize</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#searchName">searchName</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#SearchResults">SearchResults</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#sendEmail">sendEmail</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#SeriesListItem">SeriesListItem</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#SeriesSection">SeriesSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#SeriesSectionMerge">SeriesSectionMerge</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#setAttribute">setAttribute</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#setSubmitError">setSubmitError</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#setSubmitted">setSubmitted</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#showAliasEditor">showAliasEditor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#showIdentifierEditor">showIdentifierEditor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#SortNameField">SortNameField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#sortRelationshipOrdinal">sortRelationshipOrdinal</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#sortSeriesItems">sortSeriesItems</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#StatisticsPage">StatisticsPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#StrategyMock">StrategyMock</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#stringToHTMLWithLinks">stringToHTMLWithLinks</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#stripDot">stripDot</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#SubmissionSection">SubmissionSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#template">template</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#toggleShowEditionGroup">toggleShowEditionGroup</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#TopEditorsTable">TopEditorsTable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#transformISODateForDisplay">transformISODateForDisplay</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#transformISODateForSelect">transformISODateForSelect</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#transformNewForm">transformNewForm</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#unflatten">unflatten</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#UPDATE_WARN_IF_EDITION_GROUP_EXISTS">UPDATE_WARN_IF_EDITION_GROUP_EXISTS</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateAliasLanguage">updateAliasLanguage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateAliasPrimary">updateAliasPrimary</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateArea">updateArea</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateBeginArea">updateBeginArea</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateEditionGroup">updateEditionGroup</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateEndArea">updateEndArea</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateEnded">updateEnded</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateFormat">updateFormat</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateGender">updateGender</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateIdentifierType">updateIdentifierType</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateLanguageField">updateLanguageField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateLanguages">updateLanguages</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateOrderType">updateOrderType</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updatePublisher">updatePublisher</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateSeriesType">updateSeriesType</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateType">updateType</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#ValidationLabel">ValidationLabel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#ValueField">ValueField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#WorkSection">WorkSection</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#WorkSectionMerge">WorkSectionMerge</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">server/routes/entity/edition.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";

require("core-js/modules/es.object.keys.js");

require("core-js/modules/es.symbol.js");

require("core-js/modules/es.array.filter.js");

require("core-js/modules/es.object.get-own-property-descriptor.js");

require("core-js/modules/es.object.get-own-property-descriptors.js");

require("core-js/modules/es.array.iterator.js");

require("core-js/modules/es.string.iterator.js");

require("core-js/modules/es.weak-map.js");

require("core-js/modules/web.dom-collections.iterator.js");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _typeof = require("@babel/runtime/helpers/typeof");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _taggedTemplateLiteral2 = _interopRequireDefault(require("@babel/runtime/helpers/taggedTemplateLiteral"));

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

require("core-js/modules/es.parse-int.js");

require("core-js/modules/es.function.name.js");

require("core-js/modules/es.date.to-json.js");

require("core-js/modules/web.url.to-json.js");

require("core-js/modules/es.array.map.js");

require("core-js/modules/es.array.splice.js");

require("core-js/modules/es.object.to-string.js");

require("core-js/modules/web.dom-collections.for-each.js");

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _isNull2 = _interopRequireDefault(require("lodash/isNull"));

var _isEmpty2 = _interopRequireDefault(require("lodash/isEmpty"));

var _omit2 = _interopRequireDefault(require("lodash/omit"));

var _map2 = _interopRequireDefault(require("lodash/map"));

var auth = _interopRequireWildcard(require("../../helpers/auth"));

var entityRoutes = _interopRequireWildcard(require("./entity"));

var middleware = _interopRequireWildcard(require("../../helpers/middleware"));

var search = _interopRequireWildcard(require("../../../common/helpers/search"));

var utils = _interopRequireWildcard(require("../../helpers/utils"));

var _entityRouteUtils = require("../../helpers/entityRouteUtils");

var _error = require("../../../common/helpers/error");

var _types = require("../../../client/entity-editor/relationship-editor/types");

var _props = require("../../helpers/props");

var _express = _interopRequireDefault(require("express"));

var _log = _interopRequireDefault(require("log"));

var _utils2 = require("../../../common/helpers/utils");

var _target = _interopRequireDefault(require("../../templates/target"));

var _excluded = ["languageId"],
    _excluded2 = ["type"];

var _templateObject;

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop &amp;&amp; obj &amp;&amp; obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" &amp;&amp; typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache &amp;&amp; cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty &amp;&amp; Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" &amp;&amp; Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc &amp;&amp; (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i &lt; arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

/** ****************************
*********** Helpers ************
*******************************/
var additionalEditionProps = ['editionGroupBbid', 'width', 'height', 'depth', 'weight', 'pages', 'formatId', 'statusId'];

function transformNewForm(data) {
  var aliases = entityRoutes.constructAliases(data.aliasEditor, data.nameSection);
  var identifiers = entityRoutes.constructIdentifiers(data.identifierEditor);
  var relationships = entityRoutes.constructRelationships(data.relationshipSection);
  var releaseEvents = [];

  if (data.editionSection.releaseDate) {
    releaseEvents = [{
      date: data.editionSection.releaseDate
    }];
  }

  var languages = (0, _map2.default)(data.editionSection.languages, function (language) {
    return language.value;
  });
  return {
    aliases: aliases,
    annotation: data.annotationSection.content,
    depth: data.editionSection.depth &amp;&amp; parseInt(data.editionSection.depth, 10),
    disambiguation: data.nameSection.disambiguation,
    editionGroupBbid: data.editionSection.editionGroup &amp;&amp; data.editionSection.editionGroup.id,
    formatId: data.editionSection.format &amp;&amp; parseInt(data.editionSection.format, 10),
    height: data.editionSection.height &amp;&amp; parseInt(data.editionSection.height, 10),
    identifiers: identifiers,
    languages: languages,
    note: data.submissionSection.note,
    pages: data.editionSection.pages &amp;&amp; parseInt(data.editionSection.pages, 10),
    publishers: data.editionSection.publisher &amp;&amp; [data.editionSection.publisher.id],
    relationships: relationships,
    releaseEvents: releaseEvents,
    statusId: data.editionSection.status &amp;&amp; parseInt(data.editionSection.status, 10),
    weight: data.editionSection.weight &amp;&amp; parseInt(data.editionSection.weight, 10),
    width: data.editionSection.width &amp;&amp; parseInt(data.editionSection.width, 10)
  };
}

function getInitialNameSection(entity) {
  return {
    disambiguation: entity.disambiguation,
    language: entity.defaultAlias.languageId,
    languageId: entity.defaultAlias.languageId,
    name: entity.defaultAlias.name,
    primary: entity.defaultAlias.primary,
    sortName: entity.defaultAlias.sortName
  };
}

var createOrEditHandler = (0, _entityRouteUtils.makeEntityCreateOrEditHandler)('edition', transformNewForm, additionalEditionProps);
var mergeHandler = (0, _entityRouteUtils.makeEntityCreateOrEditHandler)('edition', transformNewForm, additionalEditionProps, true);
/** ****************************
*********** Routes *************
*******************************/

var router = _express.default.Router(); // Creation


router.get('/create', auth.isAuthenticated, middleware.loadIdentifierTypes, middleware.loadEditionStatuses, middleware.loadEditionFormats, middleware.loadLanguages, middleware.loadRelationshipTypes, function (req, res, next) {
  var _req$app$locals$orm = req.app.locals.orm,
      EditionGroup = _req$app$locals$orm.EditionGroup,
      Publisher = _req$app$locals$orm.Publisher,
      Work = _req$app$locals$orm.Work;
  var propsPromise = (0, _entityRouteUtils.generateEntityProps)('edition', req, res, {}); // Access edition-group property: can't write req.query.edition-group as the dash makes it invalid Javascript

  if (req.query['edition-group']) {
    propsPromise.editionGroup = EditionGroup.forge({
      bbid: req.query['edition-group']
    }).fetch({
      require: false,
      withRelated: 'defaultAlias'
    }).then(function (data) {
      return data &amp;&amp; utils.entityToOption(data.toJSON());
    });
  }

  if (req.query.publisher) {
    propsPromise.publisher = Publisher.forge({
      bbid: req.query.publisher
    }).fetch({
      require: false,
      withRelated: 'defaultAlias'
    }).then(function (data) {
      return data &amp;&amp; utils.entityToOption(data.toJSON());
    });
  }

  if (req.query.work) {
    propsPromise.work = Work.forge({
      bbid: req.query.work
    }).fetch({
      require: false,
      withRelated: 'defaultAlias'
    }).then(function (data) {
      return data &amp;&amp; utils.entityToOption(data.toJSON());
    });
  }

  function render(_x) {
    return _render.apply(this, arguments);
  }

  function _render() {
    _render = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee(props) {
      var _req$query$name, _req$query, _initialState$edition, _initialState$nameSec;

      var initialState, relationshipTypeId, initialRelationshipIndex, name, _initialState$edition2, editorMarkup, markup, updatedProps;

      return _regenerator.default.wrap(function _callee$(_context) {
        while (1) {
          switch (_context.prev = _context.next) {
            case 0:
              initialState = props.initialState;
              initialState.nameSection = {
                disambiguation: '',
                exactMatches: null,
                language: null,
                name: (_req$query$name = (_req$query = req.query) === null || _req$query === void 0 ? void 0 : _req$query.name) !== null &amp;&amp; _req$query$name !== void 0 ? _req$query$name : '',
                searchResults: null,
                sortName: ''
              };
              initialRelationshipIndex = 0;
              initialState.editionSection = (_initialState$edition = initialState.editionSection) !== null &amp;&amp; _initialState$edition !== void 0 ? _initialState$edition : {};

              if (props.publisher) {
                initialState.editionSection.publisher = props.publisher; // add initial relationship with relationshipTypeId = 4 (&lt;Publisher> published &lt; New Edition>)

                relationshipTypeId = _types.RelationshipTypes.PublisherPublishedEdition;
                (0, _entityRouteUtils.addInitialRelationship)(props, relationshipTypeId, initialRelationshipIndex++, props.publisher);
              }

              if (props.editionGroup) {
                if (!initialState.nameSection.name) {
                  // If a name hasn't been passed in query parameters, default to same name as the Edition Group
                  initialState.nameSection = getInitialNameSection(props.editionGroup);
                }

                initialState.editionSection.editionGroup = props.editionGroup; // add initial raltionship with relationshipTypeId = 3 (&lt;New Edition> is an edition of &lt;EditionGroup>)

                relationshipTypeId = _types.RelationshipTypes.EditionIsAnEditionOfEditionGroup;
                (0, _entityRouteUtils.addInitialRelationship)(props, relationshipTypeId, initialRelationshipIndex++, props.editionGroup);
              }

              if (props.work) {
                if (!initialState.nameSection.name) {
                  // If a name hasn't been passed in query parameters, default to same name as the Work
                  initialState.nameSection = getInitialNameSection(props.work);
                } // add initial raltionship with relationshipTypeId = 10 (&lt;New Edition> Contains &lt;Work>)


                relationshipTypeId = _types.RelationshipTypes.EditionContainsWork;
                (0, _entityRouteUtils.addInitialRelationship)(props, relationshipTypeId, initialRelationshipIndex++, props.work);
              }

              if (!((_initialState$nameSec = initialState.nameSection) !== null &amp;&amp; _initialState$nameSec !== void 0 &amp;&amp; _initialState$nameSec.name)) {
                _context.next = 29;
                break;
              }

              name = initialState.nameSection.name;
              _context.prev = 9;
              _context.next = 12;
              return search.autocomplete(req.app.locals.orm, name, 'Edition');

            case 12:
              initialState.nameSection.searchResults = _context.sent;
              _context.next = 15;
              return search.checkIfExists(req.app.locals.orm, name, 'Edition');

            case 15:
              initialState.nameSection.exactMatches = _context.sent;

              if (!((_initialState$edition2 = initialState.editionSection.editionGroup) !== null &amp;&amp; _initialState$edition2 !== void 0)) {
                _context.next = 20;
                break;
              }

              _context.t0 = _initialState$edition2;
              _context.next = 23;
              break;

            case 20:
              _context.next = 22;
              return search.autocomplete(req.app.locals.orm, name, 'EditionGroup');

            case 22:
              _context.t0 = _context.sent;

            case 23:
              initialState.editionSection.matchingNameEditionGroups = _context.t0;
              _context.next = 29;
              break;

            case 26:
              _context.prev = 26;
              _context.t1 = _context["catch"](9);

              _log.default.debug(_context.t1);

            case 29:
              editorMarkup = (0, _entityRouteUtils.entityEditorMarkup)(props);
              markup = editorMarkup.markup;
              updatedProps = editorMarkup.props;
              return _context.abrupt("return", res.send((0, _target.default)({
                markup: markup,
                props: (0, _props.escapeProps)(updatedProps),
                script: '/js/entity-editor.js',
                title: props.heading
              })));

            case 33:
            case "end":
              return _context.stop();
          }
        }
      }, _callee, null, [[9, 26]]);
    }));
    return _render.apply(this, arguments);
  }

  (0, _utils2.makePromiseFromObject)(propsPromise).then(render).catch(next);
});
router.post('/create', entityRoutes.displayPreview, auth.isAuthenticatedForHandler, middleware.loadIdentifierTypes, middleware.loadEditionStatuses, middleware.loadEditionFormats, middleware.loadLanguages, middleware.loadRelationshipTypes, /*#__PURE__*/function () {
  var _ref = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee2(req, res, next) {
    var entity, orm, EditionFormat, keysToInt, physicalEnable, _i, _keysToInt, key, foundOption, propsPromise, render;

    return _regenerator.default.wrap(function _callee2$(_context2) {
      while (1) {
        switch (_context2.prev = _context2.next) {
          case 0:
            render = function _render2(props) {
              var editorMarkup = (0, _entityRouteUtils.entityEditorMarkup)(props);
              var markup = editorMarkup.markup;
              var updatedProps = editorMarkup.props;
              return res.send((0, _target.default)({
                markup: markup,
                props: (0, _props.escapeProps)(updatedProps),
                script: '/js/entity-editor.js',
                title: props.heading
              }));
            };

            _context2.next = 3;
            return utils.parseInitialState(req, 'edition');

          case 3:
            entity = _context2.sent;

            if (!entity.editionSection) {
              _context2.next = 23;
              break;
            }

            orm = req.app.locals.orm;
            EditionFormat = orm.EditionFormat;
            _context2.next = 9;
            return utils.parseLanguages(entity.editionSection, orm);

          case 9:
            entity.editionSection = _context2.sent;

            if (!entity.editionSection.format) {
              _context2.next = 14;
              break;
            }

            _context2.next = 13;
            return utils.getIdByField(EditionFormat, 'label', entity.editionSection.format);

          case 13:
            entity.editionSection.format = _context2.sent;

          case 14:
            keysToInt = ['height', 'width', 'depth', 'weight', 'pages'];
            physicalEnable = false;

            for (_i = 0, _keysToInt = keysToInt; _i &lt; _keysToInt.length; _i++) {
              key = _keysToInt[_i];
              entity.editionSection[key] = parseInt(entity.editionSection[key], 10) || null;

              if (entity.editionSection[key]) {
                physicalEnable = true;
              }
            }

            entity.editionSection.physicalEnable = physicalEnable; // adding publisher

            if (!entity.editionSection.publisher) {
              _context2.next = 23;
              break;
            }

            _context2.next = 21;
            return utils.searchOption(orm, 'publisher', entity.editionSection.publisher, 'bbid', true);

          case 21:
            foundOption = _context2.sent;
            entity.editionSection.publisher = foundOption ? (0, _omit2.default)(foundOption, ['disambiguation']) : null;

          case 23:
            propsPromise = (0, _entityRouteUtils.generateEntityProps)('edition', req, res, {}, function () {
              return entity;
            });
            (0, _utils2.makePromiseFromObject)(propsPromise).then(render).catch(next);

          case 25:
          case "end":
            return _context2.stop();
        }
      }
    }, _callee2);
  }));

  return function (_x2, _x3, _x4) {
    return _ref.apply(this, arguments);
  };
}());
router.post('/create/handler', auth.isAuthenticatedForHandler, createOrEditHandler);
/* If the route specifies a BBID, make sure it does not redirect to another bbid then load the corresponding entity */

router.param('bbid', middleware.redirectedBbid);
router.param('bbid', middleware.makeEntityLoader('Edition', ['editionGroup.defaultAlias', 'languageSet.languages', 'editionFormat', 'editionStatus', 'releaseEventSet.releaseEvents', 'publisherSet.publishers.defaultAlias'], 'Edition not found'));

function _setEditionTitle(res) {
  res.locals.title = utils.createEntityPageTitle(res.locals.entity, 'Edition', utils.template(_templateObject || (_templateObject = (0, _taggedTemplateLiteral2.default)(["Edition \u201C", "\u201D"])), 'name'));
}

router.get('/:bbid', middleware.loadEntityRelationships, middleware.loadWorkTableAuthors, function (req, res) {
  _setEditionTitle(res);

  entityRoutes.displayEntity(req, res);
});
router.get('/:bbid/revisions', function (req, res, next) {
  var EditionRevision = req.app.locals.orm.EditionRevision;

  _setEditionTitle(res);

  entityRoutes.displayRevisions(req, res, next, EditionRevision);
});
router.get('/:bbid/revisions/revisions', function (req, res, next) {
  var EditionRevision = req.app.locals.orm.EditionRevision;

  _setEditionTitle(res);

  entityRoutes.updateDisplayedRevisions(req, res, next, EditionRevision);
});
router.get('/:bbid/delete', auth.isAuthenticated, function (req, res, next) {
  if (!res.locals.entity.dataId) {
    return next(new _error.ConflictError('This entity has already been deleted'));
  }

  _setEditionTitle(res);

  return entityRoutes.displayDeleteEntity(req, res);
});
router.post('/:bbid/delete/handler', auth.isAuthenticatedForHandler, function (req, res) {
  var orm = req.app.locals.orm;
  var EditionHeader = orm.EditionHeader,
      EditionRevision = orm.EditionRevision;
  return entityRoutes.handleDelete(orm, req, res, EditionHeader, EditionRevision);
});

function editionToFormState(edition) {
  /** The front-end expects a language id rather than the language object. */
  var aliases = edition.aliasSet ? edition.aliasSet.aliases.map(function (_ref2) {
    var languageId = _ref2.languageId,
        rest = (0, _objectWithoutProperties2.default)(_ref2, _excluded);
    return _objectSpread(_objectSpread({}, rest), {}, {
      language: languageId
    });
  }) : [];
  var defaultAliasIndex = entityRoutes.getDefaultAliasIndex(edition.aliasSet);
  var defaultAliasList = aliases.splice(defaultAliasIndex, 1);
  var aliasEditor = {};
  aliases.forEach(function (alias) {
    aliasEditor[alias.id] = alias;
  });
  var buttonBar = {
    aliasEditorVisible: false,
    identifierEditorVisible: false
  };
  var nameSection = (0, _isEmpty2.default)(defaultAliasList) ? {
    language: null,
    name: '',
    sortName: ''
  } : defaultAliasList[0];
  nameSection.disambiguation = edition.disambiguation &amp;&amp; edition.disambiguation.comment;
  var identifiers = edition.identifierSet ? edition.identifierSet.identifiers.map(function (_ref3) {
    var type = _ref3.type,
        rest = (0, _objectWithoutProperties2.default)(_ref3, _excluded2);
    return _objectSpread({
      type: type.id
    }, rest);
  }) : [];
  var identifierEditor = {};
  identifiers.forEach(function (identifier) {
    identifierEditor[identifier.id] = identifier;
  });
  var physicalEnable = !((0, _isNull2.default)(edition.depth) &amp;&amp; (0, _isNull2.default)(edition.height) &amp;&amp; (0, _isNull2.default)(edition.pages) &amp;&amp; (0, _isNull2.default)(edition.weight) &amp;&amp; (0, _isNull2.default)(edition.width));
  var releaseDate = edition.releaseEventSetId ? edition.releaseEventSet.releaseEvents[0].date : null;
  var publisher = edition.publisherSet &amp;&amp; ((0, _isEmpty2.default)(edition.publisherSet.publishers) ? null : utils.entityToOption(edition.publisherSet.publishers[0]));
  var editionGroup = utils.entityToOption(edition.editionGroup);
  var editionSection = {
    depth: edition.depth,
    editionGroup: editionGroup,
    // Determines whether the EG can be left blank (an EG will be auto-created) for existing Editions
    editionGroupRequired: false,
    editionGroupVisible: true,
    format: edition.editionFormat &amp;&amp; edition.editionFormat.id,
    height: edition.height,
    languages: edition.languageSet ? edition.languageSet.languages.map(function (_ref4) {
      var id = _ref4.id,
          name = _ref4.name;
      return {
        label: name,
        value: id
      };
    }) : [],
    pages: edition.pages,
    physicalEnable: physicalEnable,
    publisher: publisher,
    releaseDate: releaseDate,
    status: edition.editionStatus &amp;&amp; edition.editionStatus.id,
    weight: edition.weight,
    width: edition.width
  };
  var relationshipSection = {
    canEdit: true,
    lastRelationships: null,
    relationshipEditorProps: null,
    relationshipEditorVisible: false,
    relationships: {}
  };
  edition.relationships.forEach(function (relationship) {
    return relationshipSection.relationships["n".concat(relationship.id)] = {
      attributeSetId: relationship.attributeSetId,
      attributes: relationship.attributeSet ? relationship.attributeSet.relationshipAttributes : [],
      relationshipType: relationship.type,
      rowID: "n".concat(relationship.id),
      sourceEntity: relationship.source,
      targetEntity: relationship.target
    };
  });
  var optionalSections = {};

  if (edition.annotation) {
    optionalSections.annotationSection = edition.annotation;
  }

  return _objectSpread({
    aliasEditor: aliasEditor,
    buttonBar: buttonBar,
    editionSection: editionSection,
    identifierEditor: identifierEditor,
    nameSection: nameSection,
    relationshipSection: relationshipSection
  }, optionalSections);
}

router.get('/:bbid/edit', auth.isAuthenticated, middleware.loadIdentifierTypes, middleware.loadEditionStatuses, middleware.loadEditionFormats, middleware.loadLanguages, middleware.loadEntityRelationships, middleware.loadRelationshipTypes, function (req, res) {
  var _entityEditorMarkup = (0, _entityRouteUtils.entityEditorMarkup)((0, _entityRouteUtils.generateEntityProps)('edition', req, res, {}, editionToFormState)),
      markup = _entityEditorMarkup.markup,
      props = _entityEditorMarkup.props;

  return res.send((0, _target.default)({
    markup: markup,
    props: (0, _props.escapeProps)(props),
    script: '/js/entity-editor.js',
    title: props.heading
  }));
});
router.post('/:bbid/edit/handler', auth.isAuthenticatedForHandler, createOrEditHandler);
router.post('/:bbid/merge/handler', auth.isAuthenticatedForHandler, mergeHandler);
var _default = router;
exports.default = _default;</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Thu May 12 2022 15:04:56 GMT+0000 (Coordinated Universal Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
